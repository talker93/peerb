import{i as pe,B as fe,S as O,E as X,y as ve,C as K,q as Z,I as W,l as me,p as ge}from"./vendor.e711fc39.js";const he=function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))c(s);new MutationObserver(s=>{for(const d of s)if(d.type==="childList")for(const f of d.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&c(f)}).observe(document,{childList:!0,subtree:!0});function o(s){const d={};return s.integrity&&(d.integrity=s.integrity),s.referrerpolicy&&(d.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?d.credentials="include":s.crossorigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function c(s){if(s.ep)return;s.ep=!0;const d=o(s);fetch(s.href,d)}};he();const be={apiKey:"AIzaSyBLAS9TSpc8v-273koNVal1Tt1jes7lAQQ",authDomain:"webcodec-64053.firebaseapp.com",projectId:"webcodec-64053",storageBucket:"webcodec-64053.appspot.com",messagingSenderId:"499852745372",appId:"1:499852745372:web:c5d05223a82e7e26c86b59",measurementId:"G-TY670YZV22"};pe(be);const we={iceServers:[{urls:["stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"]}],iceCandidatePoolSize:10},v=new RTCPeerConnection(we);let E=null,ee=null,ae=null,se=0;ze(v);const te=document.getElementById("webcamButton"),T=document.getElementById("webcamVideo"),Q=document.getElementById("callButton"),oe=document.getElementById("callInput"),$=document.getElementById("answerButton"),ce=document.getElementById("remoteVideo"),ye=document.getElementById("hangupButton"),ie=document.getElementById("callMessage");let u,k,a=!1;Nexus.colors.accent="#2596be";Nexus.colors.fill="#fff";var ke=new Nexus.Toggle("#muteMo",{state:!0});ke.on("change",function(n){document.getElementById("muteMonitor").click()});var Ce=new Nexus.Toggle("#muteMy");Ce.on("change",function(n){document.getElementById("muteMe").click()});var Se=new Nexus.Select("audioSourceSelect",{size:[200,20],options:["Default - MacBook Pro Microphone","iPhone"]});Se.colorize("fill","#eee");var qe=new Nexus.Select("audioOutputSelect",{size:[200,20],options:["Defalut - MacBook Pro Speakers (Built-in)"]});qe.colorize("fill","#eee");var le=new Nexus.TextButton("#startDevices",{size:[150,50],state:!1,text:"Init",alternateText:"Activated"});le.colorize("fill","#eee");le.on("change",function(n){te.click()});var q=new Nexus.Dial("#comp_threshold",{size:[50,50],interaction:"radial",mode:"relative",min:-100,max:0,step:1,value:-24}),Ne=new Nexus.Number("#comp_threshold_val",{size:[30,20]});Ne.link(q);var N=new Nexus.Dial("#comp_knee",{size:[50,50],interaction:"radial",mode:"relative",min:0,max:40,step:1,value:30}),xe=new Nexus.Number("#comp_knee_val",{size:[30,20]});xe.link(N);var x=new Nexus.Dial("#comp_ratio",{size:[50,50],interaction:"radial",mode:"relative",min:1,max:20,step:1,value:12}),De=new Nexus.Number("#comp_ratio_val",{size:[30,20]});De.link(x);var D=new Nexus.Dial("#comp_attack",{size:[50,50],interaction:"radial",mode:"relative",min:0,max:1,step:.01,value:.003}),_e=new Nexus.Number("#comp_attack_val",{size:[30,20]});_e.link(D);var C=new Nexus.Dial("#comp_release",{size:[50,50],interaction:"radial",mode:"relative",min:0,max:1,step:.05,value:.25}),Be=new Nexus.Number("#comp_release_val",{size:[30,20]});Be.link(C);var A=new Nexus.Toggle("#comp_bypass"),w=new Nexus.Select("rev_type",{size:[200,20],options:["Block Inside","Bottle Hall","Cement Blocks 1","Cement Blocks 2","Chateau de Logne, Outside","Conic Long Echo Hall","Deep Space","Derlon Sanctuary","Direct Cabinet N1","Direct Cabinet N2"]}),L=new Nexus.Dial("#rev_mix",{size:[50,50],interaction:"radial",mode:"relative",min:0,max:20,step:1,value:10}),R=new Nexus.Toggle("#rev_bypass"),V=new Nexus.Toggle("#eq_bypass"),_=new Nexus.Select("eq_type",{size:[200,20],options:["lowshelf","highshelf"]}),B=new Nexus.Slider("eq_freq",{size:[120,20],mode:"relative",min:20,max:2e4,step:100,value:1e3}),z=new Nexus.Dial("#eq1",{size:[50,50],interaction:"radial",mode:"relative",min:-20,max:40,step:0,value:10}),M=new Nexus.Dial("#eq2",{size:[50,50],interaction:"radial",mode:"relative",min:-20,max:40,step:0,value:10}),J=new Nexus.Dial("#eq3",{size:[50,50],interaction:"radial",mode:"relative",min:-20,max:40,step:0,value:10}),j=new Nexus.Toggle("#gain_bypass"),S=new Nexus.Dial("#gain",{size:[50,50],interaction:"radial",mode:"relative",min:0,max:20,step:1,value:2}),G=new Nexus.Toggle("#pan_bypass"),I=new Nexus.Dial("#pan",{size:[50,50],interaction:"radial",mode:"relative",min:-1,max:1,step:.1,value:0}),e={comp:{attack:D.value,bypass:A.state,knee:N.value,ratio:x.value,release:C.value,threshold:q.value},rev:{type:w.value,mix:L.value,bypass:R.state},eq:{low:z.value,mid:M.value,high:J.value,bypass:V.state,freq:B.value,type:_.value},pan:{bypass:G.state,pan:I.value},gain:{bypass:j.state,gain:S.value},whatChanged:"none"};const Ie=document.getElementById("remoteVideo"),F=document.getElementById("audioSource"),H=document.getElementById("audioOutput"),ne=[F,H];function Oe(n){const l=ne.map(o=>o.value);ne.forEach(o=>{for(;o.firstChild;)o.removeChild(o.firstChild)});for(let o=0;o!==n.length;++o){const c=n[o],s=document.createElement("option");s.value=c.deviceId,c.kind==="audioinput"?(s.text=c.label||`microphone ${F.length+1}`,F.appendChild(s)):c.kind==="audiooutput"&&(s.text=c.label||`speaker ${H.length+1}`,H.appendChild(s))}ne.forEach((o,c)=>{Array.prototype.slice.call(o.childNodes).some(s=>s.value===l[c])&&(o.value=l[c])})}navigator.mediaDevices.enumerateDevices().then(Oe).catch(console.log("media query success"));function Ee(){const n=H.value;Ie.setSinkId(n).then(console.log("success"))}function re(){return{audio:{deviceId:F.value,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,latency:0,sampleRate:48e3,sampleSize:16,volume:1},video:!1}}var de=re();F.addEventListener("change",function(){de=re()});H.onchange=Ee;te.onclick=async()=>{E=await navigator.mediaDevices.getUserMedia(de),ee=new MediaStream,await Te(),E.getTracks().forEach(o=>{v.addTrack(o,E)}),v.ontrack=o=>{o.streams[0].getTracks().forEach(c=>{ee.addTrack(c)})},T.srcObject=ae,ce.srcObject=ee,T.play(),ce.play(),Q.disabled=!1,$.disabled=!1,te.disabled=!0;const n=document.getElementById("muteMonitor");n.checked==!0?T.muted=!0:T.muted=!1,n.addEventListener("change",function(){n.checked==!0?(T.muted=!0,console.log("monitor muted")):(T.muted=!1,console.log("monitor unmuted"))});const l=document.getElementById("muteMe");l.checked=!1,l.addEventListener("change",function(){l.checked==!0?(E.getTracks()[0].enabled=!1,console.log("muted me")):(E.getTracks()[0].enabled=!0,console.log("unmuted me"))})};const y=fe();Q.onclick=async()=>{u=v.createDataChannel("sendDataChannel"),u.onopen=g=>{console.log("send channel opened")},u.onclose=g=>{console.log("send channel closed")},v.ondatachannel=g=>{k=g.channel,k.onmessage=async r=>{switch(a=!0,e=JSON.parse(r.data),e.whatChanged){case"comp.threshold":await(q.value=e.comp.threshold),a=!1;break;case"comp.release":await(C.value=e.comp.release),a=!1;break;case"comp.attack":await(D.value=e.comp.attack),a=!1;break;case"comp.knee":await(N.value=e.comp.knee),a=!1;break;case"comp.ratio":await(x.value=e.comp.ratio),a=!1;break;case"comp.reduction":await(comp_recduction.value=e.comp.reduction),a=!1;break;case"rev.mix":await(L.value=e.rev.mix),a=!1;break;case"rev.type":await(w.value=e.rev.type),a=!1;break;case"eq.type":await(_.value=e.eq.type),a=!1;break;case"eq.freq":await(B.value=e.eq.freq),a=!1;break;case"eq.low":await(z.value=e.eq.low),a=!1;break;case"eq.mid":await(M.value=e.eq.mid),a=!1;break;case"eq.high":await(J.value=e.eq.high),a=!1;break;case"pan.pan":await(I.value=e.pan.pan),a=!1;break;case"gain.gain":await(S.value=e.gain.gain),a=!1;break;case"comp.bypass":await(A.state=e.comp.bypass),a=!1;break;case"rev.bypass":await(R.state=e.rev.bypass),a=!1;break;case"eq.bypass":await(V.state=e.eq.bypass),a=!1;break;case"gain.bypass":await(j.state=e.gain.bypass),a=!1;break;case"pan.bypass":await(G.state=e.pan.bypass),a=!1;break;default:console.log("invalid exchanged value"),a=!1;break}},k.onopen=r=>{console.log("receive channel opened"),p()},k.onclose=r=>{console.log("receive channel closed"),p()}};let n=document.createTextNode("You created a call.");ie.appendChild(n),Q.disabled=!0,$.disabled=!0;const l=O(y,"calls1"),o=await X(l,{});oe.value=o.id;const c=O(y,"calls1",o.id,"offerCandidates"),s=O(y,"calls1",o.id,"answerCandidates");v.onicecandidate=g=>{g.candidate&&X(c,g.candidate.toJSON()),console.log("PA updated candidates in database"),p()};const d=await v.createOffer().then(console.log("PA created offer"));p(),d.sdp=d.sdp.replace("useinbandfec=1","useinbandfec=1; stereo=1; maxaveragebitrate=510000"),await v.setLocalDescription(d).then(console.log("PA set local desc")),p();const f={sdp:d.sdp,type:d.type};await ve(K(y,"calls1",o.id),{offer:f}).then(console.log("PA updated offer in database")),p();const b=Z(K(y,"calls1",o.id));W(b,g=>{const r=g.data();if(!v.currentRemoteDescription&&(r==null?void 0:r.answer)){console.log("listen to answer triggered"),p();const h=new RTCSessionDescription(r.answer);v.setRemoteDescription(h),console.log("PA set remote desc",h),p()}});const P=Z(s);W(P,g=>{g.docChanges().forEach(r=>{if(r.type==="added"){console.log("listen to answerCandidates triggered"),p();const h=new RTCIceCandidate(r.doc.data());v.addIceCandidate(h),console.log("PA added ICE Candi: ",h),p()}})}),ye.disabled=!1};$.onclick=async()=>{u=v.createDataChannel("sendDataChannel2"),u.onopen=r=>{console.log("send channel opened")},u.onclose=r=>{console.log("send channel closed")},v.ondatachannel=r=>{k=r.channel,k.onmessage=async h=>{switch(a=!0,e=JSON.parse(h.data),e.whatChanged){case"comp.threshold":await(q.value=e.comp.threshold),a=!1;break;case"comp.release":await(C.value=e.comp.release),a=!1;break;case"comp.attack":await(D.value=e.comp.attack),a=!1;break;case"comp.knee":await(N.value=e.comp.knee),a=!1;break;case"comp.ratio":await(x.value=e.comp.ratio),a=!1;break;case"comp.reduction":await(comp_recduction.value=e.comp.reduction),a=!1;break;case"rev.mix":await(L.value=e.rev.mix),a=!1;break;case"rev.type":await(w.value=e.rev.type),a=!1;break;case"eq.type":await(_.value=e.eq.type),a=!1;break;case"eq.freq":await(B.value=e.eq.freq),a=!1;break;case"eq.low":await(z.value=e.eq.low),a=!1;break;case"eq.mid":await(M.value=e.eq.mid),a=!1;break;case"eq.high":await(J.value=e.eq.high),a=!1;break;case"pan.pan":await(I.value=e.pan.pan),a=!1;break;case"gain.gain":await(S.value=e.gain.gain),a=!1;break;case"comp.bypass":await(A.state=e.comp.bypass),a=!1;break;case"rev.bypass":await(R.state=e.rev.bypass),a=!1;break;case"eq.bypass":await(V.state=e.eq.bypass),a=!1;break;case"gain.bypass":await(j.state=e.gain.bypass),a=!1;break;case"pan.bypass":await(G.state=e.pan.bypass),a=!1;break;default:console.log("invalid exchanged value");break}},k.onopen=h=>{console.log("receive channel opened"),p()},k.onclose=h=>{console.log("receive channel closed"),p()}};let n=document.createTextNode("You answered a call!");ie.appendChild(n),Q.disabled=!0,$.disabled=!0;const l=oe.value,o=O(y,"calls1"),c=O(y,"calls1",l,"answerCandidates"),s=O(y,"calls1",l,"offerCandidates");v.onicecandidate=r=>{r.candidate&&X(c,r.candidate.toJSON()),console.log("PB updated candidate in database"),p()};const f=(await me(K(o,l))).data().offer;await v.setRemoteDescription(new RTCSessionDescription(f)),console.log("PB set remote desc"),p();const b=await v.createAnswer();b.sdp=b.sdp.replace("useinbandfec=1","useinbandfec=1; stereo=1; maxaveragebitrate=510000"),await v.setLocalDescription(b),console.log("PB set local desc"),p();const P={type:b.type,sdp:b.sdp};await ge(K(y,"calls1",l),{answer:P}),console.log("PB updated answer in database"),p();const g=Z(s);W(g,r=>{r.docChanges().forEach(h=>{if(h.type==="added"){let Y=h.doc.data(),i=new RTCIceCandidate(Y);v.addIceCandidate(i),console.log("PB added ICE Candi: ",i),p()}})})};async function Te(){var n=new AudioContext,l=n.createMediaStreamSource(E),o=n.createMediaStreamDestination();ae=o.stream,console.log(ae);var c=n.createBiquadFilter();c.type=_.value,c.frequency.value=B.value,c.gain.value=S.value;var s=n.createStereoPanner();s.pan.value=I.value;var d=n.createGain();d.gain.value=S.value;var f=n.createDynamicsCompressor();f.release.value=C.value;var b=n.createConvolver();Y(w.value).then("rev set success to: ",w.value),l.connect(f),f.connect(c),c.connect(b),b.connect(d),d.connect(s),s.connect(o),q.on("change",function(i){if(f.threshold.value=q.value,e.comp.threshold=q.value,e.whatChanged="comp.threshold",!a){const t=JSON.stringify(e);try{u.send(t)}catch(m){console.error(m)}console.log("threshold: ",e.comp.threshold)}}),C.on("change",function(i){if(f.release.value=C.value,e.comp.release=C.value,e.whatChanged="comp.release",!a){const t=JSON.stringify(e);u.send(t)}}),D.on("change",function(i){if(f.attack.value=D.value,e.comp.attack=D.value,e.whatChanged="comp.attack",!a){const t=JSON.stringify(e);u.send(t)}}),N.on("change",function(i){if(f.knee.value=N.value,e.comp.knee=N.value,e.whatChanged="comp.knee",!a){const t=JSON.stringify(e);u.send(t)}}),x.on("change",function(i){if(f.ratio.value=x.value,e.comp.ratio=x.value,e.whatChanged="comp.ratio",!a){const t=JSON.stringify(e);u.send(t)}}),L.on("change",function(i){if(e.rev.mix=L.value,e.whatChanged="rev.mix",!a){const t=JSON.stringify(e);u.send(t)}}),w.on("change",function(i){if(Y(w.value).then("rev set success to: ",w.value),e.rev.type=w.value,e.whatChanged="rev.type",!a){const t=JSON.stringify(e);u.send(t)}}),_.on("change",function(i){if(c.type=_.value,e.eq.type=_.value,e.whatChanged="eq.type",!a){const t=JSON.stringify(e);u.send(t)}}),B.on("change",function(i){if(c.frequency.value=B.value,e.eq.freq=B.value,e.whatChanged="eq.freq",!a){const t=JSON.stringify(e);u.send(t)}}),z.on("change",function(i){if(c.gain.value=z.value,e.eq.low=z.value,e.whatChanged="eq.low",!a){const t=JSON.stringify(e);u.send(t)}}),M.on("change",function(i){if(c.gain.value=M.value,e.eq.mid=M.value,e.whatChanged="eq.mid",!a){const t=JSON.stringify(e);u.send(t)}}),J.on("change",function(i){if(c.gain.value=J.value,e.eq.high=J.value,e.whatChanged="eq.high",!a){const t=JSON.stringify(e);u.send(t)}}),I.on("change",function(i){if(s.pan.value=I.value,e.pan.pan=I.value,e.whatChanged="pan.pan",!a){const t=JSON.stringify(e);u.send(t)}}),S.on("change",function(i){if(d.gain.value=S.value,e.gain.gain=S.value,e.whatChanged="gain.gain",!a){const t=JSON.stringify(e);u.send(t)}}),A.on("change",function(i){if(e.comp.bypass=A.state,e.whatChanged="comp.bypass",r(),!a){const t=JSON.stringify(e);u.send(t)}}),R.on("change",function(i){if(e.rev.bypass=R.state,e.whatChanged="rev.bypass",r(),!a){const t=JSON.stringify(e);u.send(t)}}),V.on("change",function(i){if(e.eq.bypass=V.state,e.whatChanged="eq.bypass",r(),!a){const t=JSON.stringify(e);u.send(t)}}),j.on("change",function(i){if(e.gain.bypass=j.state,e.whatChanged="gain.bypass",r(),!a){const t=JSON.stringify(e);u.send(t)}}),G.on("change",function(i){if(e.pan.bypass=G.state,e.whatChanged="pan.bypass",r(),!a){const t=JSON.stringify(e);u.send(t)}});var P=new Nexus.Oscilloscope("#oScope");P.connect(l);var g=new Nexus.Spectrogram("#spec");g.connect(l);function r(){f.disconnect(),c.disconnect(),b.disconnect(),d.disconnect(),s.disconnect();let i=[!1,e.comp.bypass,e.eq.bypass,e.rev.bypass,e.gain.bypass,e.pan.bypass,!1];var t,m;for(t=0;t<i.length-1;t++)if(!i[t]){for(m=t+1;m<i.length;m++)if(!i[m]){h(t,m);break}}}function h(i,t){let m=[l,f,c,b,d,s,o];m[i].connect(m[t])}async function Y(i){var t="https://talker93.github.io/pb/audio/"+i+".wav",m=new XMLHttpRequest;m.open("GET",t,!0),m.responseType="arraybuffer",m.onload=function(){var ue=m.response;n.decodeAudioData(ue,function(U){n.createBufferSource(),b.buffer=U},function(U){""+U.err})},m.send()}}function ze(n){n.onicegatheringstatechange=l=>{console.log("iceGatheringState: ",n.iceGatheringState),p()},n.oniceconnectionstatechange=l=>{console.log("iceConnectionState: ",n.iceConnectionState),p()},n.onconnectionstatechange=l=>{console.log("connectionState: ",n.connectionState),p()}}function p(){se=Math.floor(Date.now()%1e5),console.log("time elapsed: ",se)}
